# Terminal Guidance - Drone Companion Computer Configuration
# =========================================================

# Camera Input Configuration
camera:
  # Camera source - can be:
  # - RTSP URL: "rtsp://192.168.1.10:554/stream"
  # - Webcam index: "0" (or "1", "2", etc.)
  # - Video file: "/path/to/video.mp4"
  # - HTTP MJPEG: "http://192.168.1.129:8554/stream"
  rtsp_url: "rtsp://root:12345@192.168.2.10/stream=0"

  # Camera specifications (used for FOV calculations)
  resolution:
    width: 1280
    height: 720

  # Horizontal and vertical field of view in degrees
  fov:
    horizontal: 90.0
    vertical: 60.0

  # Capture settings
  fps: 30
  buffer_size: 1  # Keep low for minimal latency

  # Reconnection settings
  reconnect_attempts: 5
  reconnect_delay_sec: 2.0

# Detection Model Configuration
# =============================
# Available models: yolov8n (6.2MB), yolo11n (5.4MB - slightly faster)
# Available resolutions: 640, 416, 320
#
# Performance on Raspberry Pi 5 @ 3GHz (NCNN FP16):
#   640 = best range (~90-130ms), 416 = balanced (~44ms), 320 = fastest (~35ms)
#
detector:
  # Model: "yolov8n" or "yolo11n"
  model: "yolov8n"

  # Detection resolution: "640", "416", or "320"
  resolution: "640"

  # Inference settings
  confidence_threshold: 0.5
  nms_threshold: 0.45

  # Target classes to detect (COCO class names)
  # Empty list = detect all classes
  target_classes:
    - "person"
    - "car"
    - "truck"
    - "boat"

  # Performance: run detection every N frames (1 = every frame)
  # Higher values reduce CPU load, tracker interpolates between
  detection_interval: 3

# Target Tracking Configuration
tracker:
  # Tracking algorithm:
  #   "bytetrack" - Kalman + IoU matching, handles multiple objects (RECOMMENDED)
  #   "centroid"  - Simple centroid-based, fast but less robust
  algorithm: "bytetrack"

  # Max frames to keep tracking without detection
  max_disappeared: 30

  # Distance threshold for object association (pixels, used by centroid/bytetrack)
  max_distance: 150

  # Lock-on settings
  lock_on:
    # Minimum confidence to initiate lock
    min_confidence: 0.6
    # Frames target must be visible before lock
    frames_to_lock: 5
    # Frames without target before losing lock
    frames_to_unlock: 15

  # ByteTrack-specific settings (only used when algorithm: "bytetrack")
  bytetrack:
    high_thresh: 0.5   # High confidence threshold for first association pass
    low_thresh: 0.1    # Low confidence threshold for second pass (catches occluded objects)
    match_thresh: 0.8  # IoU threshold for track-detection matching

# PID Controller Configuration
# Tuned for fixed-wing intercept - gentle corrections to keep target in frame
pid:
  # Yaw control (horizontal centering) - gentle turns
  yaw:
    kp: 0.3           # Reduced for smoother turns
    ki: 0.005         # Low integral to prevent overshoot
    kd: 0.15          # Higher derivative to dampen oscillations
    max_rate: 15.0    # Max 15 deg/sec turn rate (gentle)
    derivative_filter: 0.2
    slew_rate: 20.0   # Slow ramp-up to prevent jerky turns

  # Pitch control (vertical centering / altitude)
  pitch:
    kp: 0.25          # Gentle climb/dive
    ki: 0.005
    kd: 0.12
    max_rate: 10.0    # Max 10 deg/sec pitch change
    derivative_filter: 0.2
    slew_rate: 15.0

  # Throttle control (not used for fixed-wing - throttle is set directly)
  throttle:
    kp: 0.0
    ki: 0.0
    kd: 0.0
    max_rate: 0.0
    derivative_filter: 0.0
    slew_rate: 0.0

  # Dead zone - larger zone so small errors don't cause corrections
  dead_zone_percent: 10.0

  # Control update rate (Hz)
  update_rate: 20

# MAVLink Configuration
mavlink:
  # Connection string to flight controller
  connection: "udp:192.168.1.1:14550"

  # System/Component IDs
  source_system: 255
  source_component: 190

  # Heartbeat rate (Hz)
  heartbeat_rate: 1.0

  # Command timeout (seconds)
  command_timeout: 5.0

  # Enable actual control commands (set false for testing)
  enable_control: false

  # Vehicle type: "plane" (fixed-wing), "copter", or "auto" (detect from heartbeat)
  vehicle_type: "plane"

  # Fixed-wing intercept settings
  intercept:
    cruise_throttle: 50   # Normal cruise throttle %
    tracking_throttle: 70 # Throttle when tracking %
    max_turn_rate: 45.0   # Max heading change rate (deg/sec)
    max_climb_rate: 5.0   # Max climb/dive rate (m/s)

# Safety Configuration
safety:
  # Action when target is lost: hover, loiter, rtl, continue_last, land
  target_lost_action: "loiter"

  # Maximum time to search for lost target before safety action (seconds)
  search_timeout: 10.0

  # Geofence settings
  geofence:
    enabled: true
    max_distance_m: 500  # Max distance from home
    max_altitude_m: 120  # Max altitude AGL
    min_altitude_m: 10   # Min altitude AGL

  # Emergency stop - immediately halt all tracking
  emergency_stop_enabled: true

  # Minimum battery percentage before forced RTL
  min_battery_percent: 20

  # Maximum tracking speed (m/s)
  max_tracking_speed: 10.0

  # Require ARM confirmation before tracking
  require_arm_confirmation: true

# Output Stream Configuration
output:
  # UDP H.264 stream to QGroundControl
  # QGC Settings: Video Source = UDP h.264, Port = 5600
  stream:
    enabled: true
    udp_host: "192.168.1.129"  # Mac running QGC
    udp_port: 5600

  # Output resolution (independent of input)
  resolution:
    width: 1280
    height: 720

  fps: 30
  bitrate_kbps: 2000

  # Encoding: h264, h265
  codec: "h264"

  # Hardware encoding (Pi 5 does NOT have h264_v4l2m2m, uses libx264)
  # This setting is currently unused - software encoding is always used
  hardware_encode: false

  # Overlay settings
  overlay:
    show_detections: true
    show_locked_target: true
    show_tracking_info: true
    show_telemetry: true
    font_scale: 0.6
    box_thickness: 2

# Web UI Configuration (config-only, video goes direct to QGC via UDP)
web:
  enabled: true
  host: "0.0.0.0"
  port: 5000

# Logging Configuration
logging:
  level: "INFO"  # DEBUG, INFO, WARNING, ERROR
  file: "logs/terminal_guidance.log"
  max_size_mb: 10
  backup_count: 3

  # Log performance metrics
  log_performance: true
  performance_interval_sec: 30

# System Configuration
system:
  # Threading settings
  max_workers: 4

  # GPU acceleration (if available)
  use_gpu: false

  # Performance mode: balanced, performance, power_save
  performance_mode: "balanced"
